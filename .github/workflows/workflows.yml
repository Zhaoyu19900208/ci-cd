name: Build & Load Image to Local Windows Docker

on:
  workflow_dispatch:   # 手动触发测试（推荐先用这个）
  push:              # 或 push 到 main 分支自动触发
    branches: [main]

jobs:
  ci-cd:
    runs-on: [self-hosted, actions-runner]  # 如果你加了自定义 labels
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Set up JDK 11（依你的專案改版本）
        uses: actions/setup-java@v4
        with:
          java-version: '11.0.29+7'          # 或 '17'、'11' 等
          distribution: 'Temurin'     # Adoptium / Eclipse Temurin，很穩定
      - name: Build with Maven（產生 JAR）
        if: contains(github.repository, 'ci-cd')  # 可選，判斷專案類型
        run: |
            mvn clean package -DskipTests
      - name: List generated JAR files
        run: |
          dir target\*.jar || dir build\libs\*.jar || echo "沒找到 JAR 包，請檢查 build log"
      - name: Build Docker image & Load 到這台 Windows Docker
        run: |
          docker buildx build \
            --load \
            -t ci-cd:latest \
            -f Dockerfile.glowroot \
            .
          echo "========== 建完的 images 清單 =========="
          docker images
      - name: 測試剛剛建好的 image
        run: |
          echo "成功！我是從 GitHub Actions 建出來的！"
          docker run --rm -d -p 8999:8080 --name test ci-cd:latest

