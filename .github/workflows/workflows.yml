name: Build & Load Image to Local Windows Docker

on:
  workflow_dispatch:   # 手动触发测试（推荐先用这个）
  push:              # 或 push 到 main 分支自动触发
    branches: [main]

jobs:
  ci-cd:
    runs-on: [self-hosted, actions-runner]  # 如果你加了自定义 labels
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Set up JDK 11（JDK版本）
        uses: actions/setup-java@v4
        with:
          java-version: '11.0.29+7'
          distribution: 'temurin'
      - name: Set up Maven
        uses: stCarolas/setup-maven@v4
        with:
          maven-version: '3.9.0'
      - name: Build with Maven（打JAR）
        if: contains(github.repository, 'ci-cd')  # 可選，判斷專案類型
        run: |
            mvn clean package -DskipTests
      - name: List generated JAR files（查看jar）
        run: |
          dir target\*.jar || dir build\libs\*.jar || echo "沒找到 JAR 包，請檢查 build log"
      - name: Build Docker image & Load 到 Windows Docker
        run: |
          docker buildx build \
            --load \
            -t ci-cd:latest \
            -f Dockerfile.glowroot \
            .
          echo "========== images 清单 =========="
          docker images
      - name: 建好的 image
        run: |
          echo "成功！我是 GitHub Actions 创建出来的！"
          docker run --rm -d -p 8999:8080 --name test ci-cd:latest

